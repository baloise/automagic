<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValuemationCMDB.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">automagic</a> &gt; <a href="index.source.html" class="el_package">com.baloise.automagic.cmdb.internal</a> &gt; <span class="el_source">ValuemationCMDB.groovy</span></div><h1>ValuemationCMDB.groovy</h1><pre class="source lang-java linenums">package com.baloise.automagic.cmdb.internal

import com.baloise.automagic.cmdb.CMDBService
import com.baloise.automagic.common.Registered
import com.baloise.automagic.credentials.CredentialsService
import com.baloise.automagic.properties.PropertyService
import groovy.json.JsonBuilder
import jenkins.plugins.http_request.ResponseContentSupplier

import javax.annotation.Nullable

class ValuemationCMDB extends Registered implements CMDBService {


<span class="nc" id="L15">    String getValuemationURL(){ registry.getService(PropertyService).get('VALUEMATION_URL') }</span>

<span class="nc" id="L17">    String getLink(String changeNo) {&quot;$valuemationURL/vmweb?task=runlink&amp;showgui=true&amp;subwfl=RunlinkOpenBO&amp;xparam_botype=Ticket&amp;xparam_businesskey=$changeNo&quot;}</span>

    @Override
    Map&lt;String,String&gt; createChange(String title,
                        String description,
                        String reporterUserId,
                        String approverUserId,
                        String assigneeUserId,
                        String service,
                        String system,
                        String dueDate,//&quot;YYYY-MM-dd&quot;
                        String environment,
                        String issueId,
                        String category,
                        String actualUser,
                        String status = 'To Do',
                        String parentCategory = &quot;Infrastructure-Network&quot;
                        ) {
<span class="nc" id="L35">        ResponseContentSupplier response = createOrUpdateTicket(null, title,</span>
                description,
                reporterUserId,
                approverUserId,
                assigneeUserId,
                service,
                system,
                dueDate,
                environment,
                issueId,
                category,
                actualUser,
                status,
                parentCategory)
<span class="nc" id="L49">        Map responseJSON = steps.readJSON(text: response.content)</span>
<span class="nc bnc" id="L50" title="All 22 branches missed.">        if(!responseJSON.result || responseJSON.result.score != 'success'){</span>
<span class="nc" id="L51">            throw new Exception(responseJSON.toString())</span>
        }
<span class="nc" id="L53">        String changeNo = responseJSON.result.data.ticketno</span>
<span class="nc bnc" id="L54" title="All 4 branches missed.">        [id :changeNo, link :getLink(changeNo)]</span>
    }


    String buildJSON(String workflowName, Map params) {
<span class="nc" id="L59">        registry.getService(CredentialsService).withCredentials('VALUEMATION',</span>
<span class="nc" id="L60">              ['USERNAME', 'PASSWORD','ACCESS_TOKEN']</span>
        ) {
<span class="nc" id="L62">            new JsonBuilder(</span>
                [&quot;username&quot; : steps.VALUEMATION_USERNAME,
                &quot;password&quot; : steps.VALUEMATION_PASSWORD,
                &quot;service&quot; : workflowName ,
                &quot;accessToken&quot; : steps.VALUEMATION_ACCESS_TOKEN,
                &quot;encrypted&quot; : &quot;N&quot;,
                 &quot;params&quot; : params
                ]
            ).toString()
        }
    }

<span class="nc" id="L74">    private String mapStatus(String status) { [</span>
            'To Do' : 'CH_REC',
            'In Progress' : 'CH_INIMP',
            'Approval' : 'BA_CH_TEST',
            'Closed' : 'CH_CLD'
    ][status]
    }
<span class="nc" id="L81">    private String mapEnvironment(String env) { [</span>
            'development' : 1,
            'test' : 2,
            'production' : 3,
            'training' : 4,
            'integration' : 6,
            'acceptance' : 7
<span class="nc" id="L88">    ][env.toLowerCase().trim()]</span>
    }
<span class="nc" id="L90">    private String mapService(String service) { [</span>
            'balsy ch' : 2367
<span class="nc" id="L92">    ][service.toLowerCase().trim()]</span>
    }

    ResponseContentSupplier createOrUpdateTicket(
            String ticketNo,
            String title,
            String description,
            String reporterUserId,
            String approverUserId,
            String assigneeUserId,
            String service,
            @Nullable String system,
            String dueDate,
            String environment,
            String issueId,
            String category,
            String actualUser,
            String status,
            String parentCategory
    ) {

<span class="nc bnc" id="L113" title="All 4 branches missed.">        Map params = [</span>
                &quot;ticketclass&quot;: &quot;RFC/Change&quot;,
                &quot;tickettype&quot;: &quot;Standard Change&quot;,
<span class="nc" id="L116">                &quot;status&quot;: mapStatus(status),</span>
                &quot;tckShorttext&quot;: title,
                &quot;description&quot;: description,
                &quot;statementtype&quot;: &quot;Information&quot;,
                &quot;persnoReqBy&quot;: reporterUserId,
                &quot;persnoAffected&quot;: assigneeUserId, // changeOwner
                &quot;catParent&quot;: parentCategory,
                &quot;category&quot;: category,
<span class="nc" id="L124">                &quot;servicesid&quot;: mapService(service),</span>
                &quot;system&quot;: system,
                &quot;dueDate&quot;: dueDate,
<span class="nc" id="L127">                &quot;environmentId&quot;: mapEnvironment(environment),</span>
                &quot;personcurrent&quot;: actualUser,
                &quot;actualUser&quot; : actualUser,
                &quot;changeOwnerPersonNo&quot;: approverUserId,
                &quot;changeOwnerGroup&quot;: &quot;CHANGE MANAGER&quot;
        ]

<span class="nc bnc" id="L134" title="All 2 branches missed.">        if(ticketNo) {</span>
<span class="nc" id="L135">            params.ticketno = ticketNo</span>
        }

<span class="nc" id="L138">        String body = buildJSON(</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                ticketNo ? 'UpdateBAStandardChange' : 'CreateBAStandardChange',</span>
                params)
<span class="nc" id="L141">        steps.echo body</span>
<span class="nc" id="L142">        return steps.httpRequest(</span>
                acceptType: 'APPLICATION_JSON',
                contentType: 'APPLICATION_JSON',
                httpMode: 'POST',
                requestBody: body,
                url: &quot;$valuemationURL/services/api/execwf&quot;
        )
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>